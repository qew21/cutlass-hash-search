name: LLM PR Review

permissions:
  contents: read    # é»˜è®¤å°±æœ‰ï¼Œä¿ç•™
  pull-requests: write     # å…è®¸ç»™ PR è´´ comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  llm_review:
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ•µï¸ Inspect GITHUB_TOKEN permissions"
        uses: actions/github-script@v7
        with:
          script: |
            console.log("Inspecting token permissions...");
            const response = await github.request("/"); // è°ƒç”¨ä¸€ä¸ªæœ€åŸºç¡€çš„APIç«¯ç‚¹
            const scopes = response.headers['x-oauth-scopes'];
            console.log("Token Scopes:", scopes);
            if (!scopes || !scopes.includes("pull_requests:write")) {
              core.setFailed("âŒ Critical: The token does not have 'pull-requests:write' permission. Scopes found: " + scopes);
            } else {
              console.log("âœ… The token has the required 'pull-requests:write' permission.");
            }
      - name: Checkout ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0        # éœ€è¦å®Œæ•´å†å²ä»¥è·å– diff

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install openai requests

      - name: è¿è¡Œ PR Review è„šæœ¬
        env:
          # OpenAI é…ç½®ï¼Œä» Secrets ä¸­è¯»å–
          OPENAI_API_KEY:   ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE:  ${{ secrets.OPENAI_API_BASE }}
          OPENAI_MODEL:  ${{ secrets.OPENAI_MODEL }}
          # GitHub è¿è¡Œæ—¶è‡ªåŠ¨æä¾›
          GITHUB_TOKEN:     ${{ secrets.GITHUB_TOKEN }}
          # ä¼ é€’ç»™è„šæœ¬çš„å‚æ•°
          GITHUB_REPOSITORY:             ${{ github.repository }}
          GITHUB_EVENT_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_BASE_REF:               ${{ github.event.pull_request.base.ref }}
          GITHUB_SHA:                    ${{ github.sha }}
        run: |
          python scripts/pr_review.py
